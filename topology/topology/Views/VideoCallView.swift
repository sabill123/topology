import SwiftUI
import AVFoundation

// ÎπÑÎîîÏò§ ÌÜµÌôî ÌôîÎ©¥
struct VideoCallView: View {
    let friend: Friend
    @State private var isCameraOn = true
    @State private var isMicOn = true
    @State private var isFlipped = false
    @State private var showDisconnectAlert = false
    @State private var showMoreOptions = false
    @Environment(\.presentationMode) var presentationMode
    
    var body: some View {
        VideoCallSessionView(
            partner: friend,
            isCameraOn: $isCameraOn,
            isMicOn: $isMicOn,
            isFlipped: $isFlipped,
            onDisconnect: {
                presentationMode.wrappedValue.dismiss()
            }
        )
        .navigationBarHidden(true)
    }
}

// ÌôîÏÉÅ ÌÜµÌôî ÏÑ∏ÏÖò ÌôîÎ©¥
struct VideoCallSessionView: View {
    let partner: Friend
    @Binding var isCameraOn: Bool
    @Binding var isMicOn: Bool
    @Binding var isFlipped: Bool
    var onDisconnect: () -> Void
    
    @State private var elapsedSeconds = 0
    @State private var timer = Timer.publish(every: 1, on: .main, in: .common).autoconnect()
    @State private var showDisconnectAlert = false
    @State private var showMoreOptions = false
    @State private var showFilterView = false
    @State private var currentFilter: String? = nil
    
    var body: some View {
        ZStack {
            // ÏÉÅÎåÄÎ∞© ÎπÑÎîîÏò§
            Color.black.ignoresSafeArea()
                .overlay(
                    VStack {
                        Text("üë§")
                            .font(.system(size: 100))
                            .foregroundColor(.white.opacity(0.5))
                        Text(partner.name)
                            .font(.title2)
                            .foregroundColor(.white)
                        Text("\(partner.age)ÏÑ∏ ‚Ä¢ \(partner.country)")
                            .font(.subheadline)
                            .foregroundColor(.gray)
                    }
                )
            
            VStack {
                // ÏÉÅÎã® Ï†ïÎ≥¥
                HStack {
                    VStack(alignment: .leading, spacing: 4) {
                        Text(partner.name)
                            .font(.headline)
                            .foregroundColor(.white)
                        
                        Text("\(partner.age)ÏÑ∏ ‚Ä¢ \(partner.country)")
                            .font(.caption)
                            .foregroundColor(.gray)
                    }
                    .padding(10)
                    .background(Color.black.opacity(0.5))
                    .cornerRadius(8)
                    
                    Spacer()
                    
                    Text(formattedElapsedTime)
                        .font(.headline)
                        .foregroundColor(.white)
                        .padding(8)
                        .background(Color.black.opacity(0.5))
                        .cornerRadius(8)
                }
                .padding()
                
                Spacer()
                
                // ÎÇ¥ ÎπÑÎîîÏò§ (PIP)
                MyVideoPreview(isCameraOn: $isCameraOn, isFlipped: $isFlipped, currentFilter: $currentFilter)
                    .padding()
                
                // ÌÜµÌôî Ïª®Ìä∏Î°§
                CallControlButtons(
                    isMicOn: $isMicOn,
                    isCameraOn: $isCameraOn,
                    showDisconnectAlert: $showDisconnectAlert,
                    showMoreOptions: $showMoreOptions
                )
                .padding(.bottom, 30)
            }
        }
        .statusBar(hidden: true)
        .navigationBarHidden(true)
        .onReceive(timer) { _ in
            elapsedSeconds += 1
        }
        .alert(isPresented: $showDisconnectAlert) {
            Alert(
                title: Text("ÌÜµÌôî Ï¢ÖÎ£å"),
                message: Text("Ï†ïÎßê ÌÜµÌôîÎ•º Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?"),
                primaryButton: .destructive(Text("Ï¢ÖÎ£å")) {
                    onDisconnect()
                },
                secondaryButton: .cancel(Text("Ï∑®ÏÜå"))
            )
        }
        .actionSheet(isPresented: $showMoreOptions) {
            ActionSheet(
                title: Text("Ï∂îÍ∞Ä ÏòµÏÖò"),
                buttons: [
                    .default(Text("ÏπúÍµ¨ Ï∂îÍ∞Ä")) {
                        // ÏπúÍµ¨ Ï∂îÍ∞Ä Î°úÏßÅ
                    },
                    .default(Text("ÌïÑÌÑ∞ Î≥ÄÍ≤Ω")) {
                        showFilterView = true
                    },
                    .default(Text("Ïã†Í≥†ÌïòÍ∏∞")) {
                        // Ïã†Í≥† Î°úÏßÅ
                    },
                    .cancel()
                ]
            )
        }
        .sheet(isPresented: $showFilterView) {
            FilterView(currentFilter: $currentFilter)
        }
    }
    
    // Í≤ΩÍ≥º ÏãúÍ∞Ñ Ìè¨Îß∑
    var formattedElapsedTime: String {
        let minutes = elapsedSeconds / 60
        let seconds = elapsedSeconds % 60
        return String(format: "%02d:%02d", minutes, seconds)
    }
}

// ÎÇ¥ ÎπÑÎîîÏò§ ÌîÑÎ¶¨Î∑∞
struct MyVideoPreview: View {
    @Binding var isCameraOn: Bool
    @Binding var isFlipped: Bool
    @Binding var currentFilter: String?
    
    var body: some View {
        ZStack(alignment: .topTrailing) {
            if isCameraOn {
                ZStack {
                    Color.gray
                        .frame(width: 120, height: 160)
                        .cornerRadius(12)
                    
                    Text("üë§")
                        .font(.system(size: 30))
                        .foregroundColor(.white)
                    
                    // ÌïÑÌÑ∞ Ïò§Î≤ÑÎ†àÏù¥
                    if let filter = currentFilter, filter != "ÏóÜÏùå" {
                        filterOverlay(for: filter)
                    }
                }
            } else {
                Color.black
                    .frame(width: 120, height: 160)
                    .cornerRadius(12)
                    .overlay(
                        VStack {
                            Image(systemName: "video.slash.fill")
                                .font(.system(size: 24))
                                .foregroundColor(.white)
                            Text("Ïπ¥Î©îÎùº Í∫ºÏßê")
                                .font(.caption)
                                .foregroundColor(.white)
                        }
                    )
            }
            
            Button(action: {
                isFlipped.toggle()
            }) {
                Image(systemName: "arrow.triangle.2.circlepath")
                    .padding(8)
                    .background(Color.black.opacity(0.6))
                    .foregroundColor(.white)
                    .clipShape(Circle())
            }
            .padding(8)
        }
        .offset(x: 100)
    }
    
    func filterOverlay(for filter: String) -> some View {
        Group {
            switch filter {
            case "Î∑∞Ìã∞":
                Color.pink.opacity(0.3)
                    .cornerRadius(12)
            case "Î∞òÏßùÏù¥":
                ZStack {
                    ForEach(0..<10) { _ in
                        Circle()
                            .fill(Color.yellow)
                            .frame(width: 4, height: 4)
                            .position(
                                x: CGFloat.random(in: 0...120),
                                y: CGFloat.random(in: 0...160)
                            )
                    }
                }
            case "Î™®ÎÖ∏ÌÜ§":
                Color.gray.opacity(0.7)
                    .blendMode(.saturation)
                    .cornerRadius(12)
            case "ÎπàÌã∞ÏßÄ":
                Color.yellow.opacity(0.3)
                    .blendMode(.multiply)
                    .cornerRadius(12)
            default:
                EmptyView()
            }
        }
    }
}

// ÌÜµÌôî Ïª®Ìä∏Î°§ Î≤ÑÌäºÎì§
struct CallControlButtons: View {
    @Binding var isMicOn: Bool
    @Binding var isCameraOn: Bool
    @Binding var showDisconnectAlert: Bool
    @Binding var showMoreOptions: Bool
    
    var body: some View {
        HStack(spacing: 20) {
            Button(action: {
                isMicOn.toggle()
            }) {
                Image(systemName: isMicOn ? "mic.fill" : "mic.slash.fill")
                    .font(.system(size: 24))
                    .padding()
                    .background(Color.white.opacity(0.2))
                    .clipShape(Circle())
                    .foregroundColor(.white)
            }
            
            Button(action: {
                showDisconnectAlert = true
            }) {
                Image(systemName: "phone.down.fill")
                    .font(.system(size: 24))
                    .padding()
                    .background(Color.red)
                    .clipShape(Circle())
                    .foregroundColor(.white)
            }
            
            Button(action: {
                isCameraOn.toggle()
            }) {
                Image(systemName: isCameraOn ? "video.fill" : "video.slash.fill")
                    .font(.system(size: 24))
                    .padding()
                    .background(Color.white.opacity(0.2))
                    .clipShape(Circle())
                    .foregroundColor(.white)
            }
            
            Button(action: {
                showMoreOptions = true
            }) {
                Image(systemName: "ellipsis")
                    .font(.system(size: 24))
                    .padding()
                    .background(Color.white.opacity(0.2))
                    .clipShape(Circle())
                    .foregroundColor(.white)
            }
        }
    }
}

// Ïó∞Í≤∞ Ï§ë ÌôîÎ©¥
struct ConnectingView: View {
    @State private var dots = ""
    @State private var dotCount = 0
    let timer = Timer.publish(every: 0.5, on: .main, in: .common).autoconnect()
    var onConnected: () -> Void
    
    var body: some View {
        ZStack {
            Color.black.opacity(0.7)
                .edgesIgnoringSafeArea(.all)
            
            VStack(spacing: 20) {
                Text("Ïó∞Í≤∞ Ï§ë\(dots)")
                    .font(.title)
                    .foregroundColor(.white)
                
                ProgressView()
                    .progressViewStyle(CircularProgressViewStyle(tint: .white))
                    .scaleEffect(1.5)
                
                Text("Ï†ÅÌï©Ìïú ÏÉÅÎåÄÎ•º Ï∞æÍ≥† ÏûàÏäµÎãàÎã§")
                    .foregroundColor(.gray)
                
                Button(action: {
                    onConnected()
                }) {
                    Text("Ï∑®ÏÜå")
                        .foregroundColor(.white)
                        .padding(.horizontal, 20)
                        .padding(.vertical, 10)
                        .background(Color.red.opacity(0.8))
                        .cornerRadius(8)
                }
                .padding(.top, 20)
            }
            .padding()
        }
        .onReceive(timer) { _ in
            dotCount = (dotCount + 1) % 4
            dots = String(repeating: ".", count: dotCount)
            
            // ÌÖåÏä§Ìä∏Î•º ÏúÑÌï¥ 3Ï¥à ÌõÑ ÏûêÎèô Ïó∞Í≤∞
            DispatchQueue.main.asyncAfter(deadline: .now() + 3) {
                onConnected()
            }
        }
    }
}

// Ïπ¥Î©îÎùº ÎØ∏Î¶¨Î≥¥Í∏∞ Î∑∞
struct CameraPreviewView: View {
    var isCameraOn: Bool
    
    var body: some View {
        ZStack {
            Color.black.edgesIgnoringSafeArea(.all)
            
            if isCameraOn {
                Color.gray.opacity(0.3)
                    .edgesIgnoringSafeArea(.all)
                
                VStack {
                    Spacer()
                    
                    Text("üë§")
                        .font(.system(size: 100))
                        .foregroundColor(.white.opacity(0.5))
                    
                    Text("Ïπ¥Î©îÎùº ÎØ∏Î¶¨Î≥¥Í∏∞")
                        .font(.headline)
                        .foregroundColor(.white.opacity(0.7))
                    
                    Spacer()
                }
            } else {
                VStack {
                    Spacer()
                    
                    Image(systemName: "video.slash.fill")
                        .font(.system(size: 50))
                        .foregroundColor(.white.opacity(0.5))
                    
                    Text("Ïπ¥Î©îÎùºÍ∞Ä Í∫ºÏ†∏ ÏûàÏäµÎãàÎã§")
                        .font(.headline)
                        .foregroundColor(.white.opacity(0.7))
                        .padding(.top)
                    
                    Text("ÌôîÏÉÅ Ï±ÑÌåÖÏùÑ ÏãúÏûëÌïòÎ†§Î©¥ Ïπ¥Î©îÎùºÎ•º ÏºúÏ£ºÏÑ∏Ïöî")
                        .font(.subheadline)
                        .foregroundColor(.white.opacity(0.5))
                        .multilineTextAlignment(.center)
                        .padding(.horizontal, 40)
                        .padding(.top, 8)
                    
                    Spacer()
                }
            }
        }
    }
}